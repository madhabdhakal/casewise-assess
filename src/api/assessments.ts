import { FastifyInstance, FastifyRequest, FastifyReply } from 'fastify';\nimport { AssessmentService } from '../services/assessment-service';\nimport { authenticateApiKey, AuthenticatedRequest } from '../utils/auth';\nimport { Guardrails } from '../utils/guardrails';\nimport * as fs from 'fs';\n\nexport async function assessmentRoutes(fastify: FastifyInstance) {\n  \n  // Create assessment\n  fastify.post('/v1/assessments', {\n    preHandler: authenticateApiKey,\n    schema: {\n      tags: ['Assessments'],\n      summary: 'Create new assessment',\n      body: {\n        type: 'object',\n        required: ['profile_data', 'policy_snapshot_id'],\n        properties: {\n          profile_data: {\n            type: 'object',\n            description: 'Complete applicant profile data'\n          },\n          policy_snapshot_id: {\n            type: 'string',\n            description: 'Policy snapshot identifier'\n          }\n        }\n      },\n      response: {\n        201: {\n          type: 'object',\n          properties: {\n            assessment_id: { type: 'string' },\n            status: { type: 'string' },\n            created_at: { type: 'string' }\n          }\n        }\n      }\n    }\n  }, async (request: FastifyRequest<{\n    Body: {\n      profile_data: any;\n      policy_snapshot_id: string;\n    }\n  }>, reply: FastifyReply) => {\n    try {\n      const { profile_data, policy_snapshot_id } = request.body;\n      const { tenant } = request as AuthenticatedRequest;\n      \n      // Validate content\n      const validation = Guardrails.validateReportContent(JSON.stringify(profile_data));\n      if (!validation.valid) {\n        return reply.code(400).send({ \n          error: 'Content validation failed', \n          violations: validation.violations \n        });\n      }\n      \n      // Create assessment\n      const { assessmentId } = await AssessmentService.createAssessment(\n        tenant.id,\n        profile_data,\n        policy_snapshot_id\n      );\n      \n      // Run assessment asynchronously\n      AssessmentService.runAssessment(assessmentId).catch(console.error);\n      \n      return reply.code(201).send({\n        assessment_id: assessmentId,\n        status: 'pending',\n        created_at: new Date().toISOString()\n      });\n      \n    } catch (error) {\n      console.error('Assessment creation error:', error);\n      return reply.code(500).send({ error: 'Internal server error' });\n    }\n  });\n  \n  // Get assessment\n  fastify.get('/v1/assessments/:id', {\n    preHandler: authenticateApiKey,\n    schema: {\n      tags: ['Assessments'],\n      summary: 'Get assessment details',\n      params: {\n        type: 'object',\n        properties: {\n          id: { type: 'string' }\n        }\n      }\n    }\n  }, async (request: FastifyRequest<{\n    Params: { id: string }\n  }>, reply: FastifyReply) => {\n    try {\n      const { id } = request.params;\n      const { tenant } = request as AuthenticatedRequest;\n      \n      const assessment = await AssessmentService.getAssessment(id, tenant.id);\n      \n      if (!assessment) {\n        return reply.code(404).send({ error: 'Assessment not found' });\n      }\n      \n      return reply.send(assessment);\n      \n    } catch (error) {\n      console.error('Get assessment error:', error);\n      return reply.code(500).send({ error: 'Internal server error' });\n    }\n  });\n  \n  // Get HTML report\n  fastify.get('/v1/assessments/:id/report.html', {\n    preHandler: authenticateApiKey,\n    schema: {\n      tags: ['Reports'],\n      summary: 'Get HTML report',\n      params: {\n        type: 'object',\n        properties: {\n          id: { type: 'string' }\n        }\n      }\n    }\n  }, async (request: FastifyRequest<{\n    Params: { id: string }\n  }>, reply: FastifyReply) => {\n    try {\n      const { id } = request.params;\n      const { tenant } = request as AuthenticatedRequest;\n      \n      let report = await AssessmentService.getReport(id, tenant.id);\n      \n      if (!report) {\n        // Generate report if not exists\n        const htmlContent = await AssessmentService.generateReport(id);\n        return reply.type('text/html').send(htmlContent);\n      }\n      \n      return reply.type('text/html').send(report.html_content);\n      \n    } catch (error) {\n      console.error('Get HTML report error:', error);\n      return reply.code(500).send({ error: 'Internal server error' });\n    }\n  });\n  \n  // Get PDF report\n  fastify.get('/v1/assessments/:id/report.pdf', {\n    preHandler: authenticateApiKey,\n    schema: {\n      tags: ['Reports'],\n      summary: 'Get PDF report',\n      params: {\n        type: 'object',\n        properties: {\n          id: { type: 'string' }\n        }\n      }\n    }\n  }, async (request: FastifyRequest<{\n    Params: { id: string }\n  }>, reply: FastifyReply) => {\n    try {\n      const { id } = request.params;\n      const { tenant } = request as AuthenticatedRequest;\n      \n      const report = await AssessmentService.getReport(id, tenant.id);\n      \n      if (!report || !report.pdf_path) {\n        return reply.code(404).send({ error: 'PDF report not available' });\n      }\n      \n      if (!fs.existsSync(report.pdf_path)) {\n        return reply.code(404).send({ error: 'PDF file not found' });\n      }\n      \n      const pdfBuffer = fs.readFileSync(report.pdf_path);\n      const filename = `assessment-report-${id.substring(0, 8)}.pdf`;\n      \n      return reply\n        .type('application/pdf')\n        .header('Content-Disposition', `attachment; filename=\"${filename}\"`)\n        .send(pdfBuffer);\n        \n    } catch (error) {\n      console.error('Get PDF report error:', error);\n      return reply.code(500).send({ error: 'Internal server error' });\n    }\n  });\n  \n  // Add signoff\n  fastify.post('/v1/assessments/:id/signoff', {\n    preHandler: authenticateApiKey,\n    schema: {\n      tags: ['Assessments'],\n      summary: 'Add RMA signoff',\n      params: {\n        type: 'object',\n        properties: {\n          id: { type: 'string' }\n        }\n      },\n      body: {\n        type: 'object',\n        required: ['reviewer_name', 'mara_number'],\n        properties: {\n          reviewer_name: { type: 'string' },\n          mara_number: { type: 'string', pattern: '^[0-9]{7}$' },\n          comments: { type: 'string' }\n        }\n      }\n    }\n  }, async (request: FastifyRequest<{\n    Params: { id: string };\n    Body: {\n      reviewer_name: string;\n      mara_number: string;\n      comments?: string;\n    }\n  }>, reply: FastifyReply) => {\n    try {\n      const { id } = request.params;\n      const { reviewer_name, mara_number, comments } = request.body;\n      \n      // Validate content\n      const validation = Guardrails.validateReportContent(`${reviewer_name} ${comments || ''}`);\n      if (!validation.valid) {\n        return reply.code(400).send({ \n          error: 'Content validation failed', \n          violations: validation.violations\n        });\n      }\n      \n      await AssessmentService.addSignoff(id, reviewer_name, mara_number, comments);\n      \n      return reply.code(201).send({ success: true });\n      \n    } catch (error) {\n      console.error('Add signoff error:', error);\n      return reply.code(500).send({ error: 'Internal server error' });\n    }\n  });\n}